<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Presença Catequese</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f9; padding: 20px; color: #333; }
        h1, h2, h3 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 5px; margin-top: 20px; }
        section { background-color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        input[type="text"], select, textarea { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        ul#lista-turmas li { background-color: #e9ecef; margin: 5px 0; padding: 10px; border-radius: 4px; cursor: pointer; }
        ul#lista-turmas li:hover { background-color: #cfd6de; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        table, th, td { border: 1px solid #ddd; }
        th, td { padding: 10px; text-align: left; }
        th { background-color: #f2f2f2; }
        .header-image {
            width: 100%; max-width: 1200px; height: auto; display: block; margin: 0 auto 20px auto; 
            border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        /* Estilos da Matriz de Presença */
        .matriz-container { overflow-x: auto; }
        .matriz-presenca th, .matriz-presenca td { white-space: nowrap; padding: 5px; text-align: center; }
        .matriz-presenca select { 
            padding: 2px; border: 1px solid #ccc; border-radius: 3px; 
            font-size: 0.8em; min-width: 60px; height: 28px;
            text-align: center;
        }
        /* Cores para os status */
        .P { background-color: #d4edda; color: #155724; } /* Verde */
        .F { background-color: #f8d7da; color: #721c24; } /* Vermelho */
        .FJ { background-color: #fff3cd; color: #856404; } /* Amarelo */
        .FR { background-color: #cce5ff; color: #004085; } /* Azul */
    </style>
</head>
<body>
    
    <!-- CABEÇALHO COM IMAGEM (Link direto para o GitHub) -->
    <img src="https://raw.githubusercontent.com/pnscpastoraldacatequese-commits/RegistroDePresenca2026/main/CABE%C3%87ALHO.jpeg" 
         alt="Banner de Cabeçalho - Registro de Presença Catequese" 
         class="header-image"
         onerror="this.src='https://placehold.co/1200x150/4c7cbf/ffffff?text=FALHA+AO+CARREGAR+IMAGEM+DO+GITHUB';">

    <!-- MENSAGEM DE STATUS DA CONEXÃO -->
    <div id="status-message" style="color: red; background-color: #ffe0e0; border: 1px solid red; padding: 10px; margin-bottom: 15px; display: none;">
        Verificando conexão com o Firebase...
    </div>

    <!-- 1. PAINEL ADMINISTRATIVO (Visível sem ID na URL) -->
    <div id="admin-panel" style="display: none;">
        <h1>Painel Administrativo</h1>
        
        <section>
            <h2>Gerenciar Turmas (CRUD)</h2>
            <form id="form-turma">
                <input type="text" id="turma-id" placeholder="ID da Turma (Ex: A1)" required>
                <input type="text" id="turma-nome" placeholder="Nome da Turma" required>
                <input type="text" id="turma-catequista" placeholder="Nome do Catequista" required>
                
                <label for="turma-dia-semana" style="display: block; margin-top: 8px;">Dia da Semana do Encontro:</label>
                <select id="turma-dia-semana" required style="width: 100%;">
                    <option value="">Selecione o Dia</option>
                    <option value="terca">Terça</option>
                    <option value="quarta">Quarta</option>
                    <option value="sabado">Sábado</option>
                </select>

                <!-- Campo para a chave secreta que será usada no link do catequista -->
                <input type="text" id="turma-chave" placeholder="Chave Secreta (Senha de Accesso da Turma)" required>
                <button type="submit">Adicionar/Atualizar Turma</button>
            </form>
            
            <h3>Adicionar Turmas em Lote</h3>
            <p>Formato: ID,Nome,Catequista,ChaveSecreta,DiaDaSemana (uma por linha)</p>
            <textarea id="turmas-lote" rows="5" placeholder="A1,Eucaristia A,Maria Silva,senha123,terca&#10;B2,Crisma B,João Souza,chave456,sabado"></textarea>
            <button id="btn-adicionar-turmas-lote">Adicionar em Lote</button>
            
            <h3>Turmas Existentes (Clique para Editar)</h3>
            <ul id="lista-turmas"></ul>
        </section>

        <section>
            <h2>Gerenciar Catequizandos (CRUD)</h2>
            <label for="turma-selecionada-participante">Vincular à Turma:</label>
            <select id="turma-selecionada-participante" required>
                <option value="">Carregando Turmas...</option>
            </select>

            <form id="form-participante">
                <input type="text" id="participante-nome" placeholder="Nome Completo" required>
                <button type="submit">Adicionar Catequizando</button>
            </form>

            <h3>Adicionar Catequizandos em Lote</h3>
            <p>Formato: Nome Completo (uma por linha, o ID será gerado automaticamente)</p>
            <textarea id="participantes-lote" rows="5" placeholder="Ana Costa&#10;Bruno Lopes"></textarea>
            <button id="btn-adicionar-participantes-lote">Adicionar em Lote</button>
        </section>

        <!-- Gerenciar Calendário -->
        <section>
            <h2>Gerenciar Calendário de Encontros e Missas</h2>
            
            <!-- NOVO: Gerador de Período -->
            <div style="border: 1px dashed #007bff; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                <h3>Geração de Datas por Período</h3>
                <p>Preencha as datas (AAAA-MM-DD) para gerar e salvar um lote de datas automaticamente.</p>
                
                <input type="text" id="range-start-date" placeholder="Data de Início (AAAA-MM-DD)" style="width: 49%; display: inline-block;">
                <input type="text" id="range-end-date" placeholder="Data Final (AAAA-MM-DD)" style="width: 49%; display: inline-block;">
                
                <label for="range-target-day" style="display: block; margin-top: 8px;">Dia da Semana a ser Gerado:</label>
                <select id="range-target-day" style="width: 100%;">
                    <option value="">(Selecione o Dia)</option>
                    <option value="6">Sábado</option>
                    <option value="2">Terça</option>
                    <option value="3">Quarta</option>
                    <option value="all">Missas (Todos os dias)</option>
                </select>
                
                <label for="range-target-doc" style="display: block; margin-top: 8px;">Documento de Destino (Obrigatório):</label>
                <select id="range-target-doc" style="width: 100%;">
                    <option value="">(Selecione o Destino)</option>
                    <option value="encontros_terca">Encontros Terça</option>
                    <option value="encontros_quarta">Encontros Quarta</option>
                    <option value="encontros_sabado">Encontros Sábado</option>
                    <option value="missas">Datas de Missa</option>
                </select>

                <button id="btn-salvar-range-datas">Gerar Datas e SALVAR no Firestore</button>
                <p id="range-status" style="margin-top: 10px; font-size: 0.9em;"></p>
            </div>


            <p><strong>Instrução:</strong> Edite o campo abaixo apenas para inclusões manuais ou remoção de recessos.</p>

            <h3>Encontros (Terça)</h3>
            <p>Documento: <code>calendario/encontros_terca</code></p>
            <textarea id="datas-terca" rows="3" placeholder="2026-03-03&#10;2026-03-10"></textarea>
            <button id="btn-salvar-terca">Salvar Encontros Terça</button>

            <h3>Encontros (Quarta)</h3>
            <p>Documento: <code>calendario/encontros_quarta</code></p>
            <textarea id="datas-quarta" rows="3" placeholder="2026-03-04&#10;2026-03-11"></textarea>
            <button id="btn-salvar-quarta">Salvar Encontros Quarta</button>

            <h3>Encontros (Sábado)</h3>
            <p>Documento: <code>calendario/encontros_sabado</code></p>
            <textarea id="datas-sabado" rows="3" placeholder="2026-03-07&#10;2026-03-14"></textarea>
            <button id="btn-salvar-sabado">Salvar Encontros Sábado</button>
            
            <hr style="margin: 15px 0;">

            <h3>Datas de Missa</h3>
            <p>Documento: <code>calendario/missas</code></p>
            <textarea id="datas-missas" rows="3" placeholder="2026-03-01&#10;2026-03-08 (Datas de missa obrigatória)"></textarea>
            <button id="btn-salvar-missas">Salvar Datas de Missa</button>
        </section>
        
        <section>
            <h2>Relatórios de Presença</h2>
            <label for="turma-selecionada-relatorio">Selecionar Turma:</label>
            <select id="turma-selecionada-relatorio" required>
                <option value="">Carregando Turmas...</option>
            </select>
            <button id="btn-gerar-relatorio">Gerar Relatório</button>
            <div id="resultado-relatorio"></div>
        </section>
    </div>


    <!-- 2. PÁGINA DO CATEQUISTA (Visível com ID na URL) -->
    <div id="catequista-page" style="display: none;">
        <h1 id="titulo-turma">Registro de Presença</h1>
        <p id="turma-info" style="font-size: 1.2em; font-weight: bold;"></p>
        
        <section>
            <h2>Matriz de Presença</h2>
            <div id="matriz-presenca-status" style="margin-bottom: 10px;"></div>
            <div class="matriz-container">
                <table id="matriz-tabela" class="matriz-presenca">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- --------------------------------------- -->
    <!-- Configurações e Script -->
    <!-- --------------------------------------- -->
    <script type="module">
        // Importa módulos necessários do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        
        // Importações modulares: getFirestore, doc, collection, query, where, getDocs, onSnapshot, etc.
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy, limit, serverTimestamp, Timestamp, writeBatch } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Variáveis globais para simular o ambiente Canvas
        const firebaseConfig = {
            apiKey: "AIzaSyDqn5MejlYyNmXK-OZayhOZ5SrzN3YcNCM", // CREDENCIAL ATUALIZADA
            authDomain: "dados-catequese.firebaseapp.com",
            projectId: "dados-catequese",
            storageBucket: "dados-catequese.firebasestorage.app",
            messagingSenderId: "420948905617",
            appId: "1:420948905617:web:b08e29cf5073ff804f930"
        };
        
        // Mapeamento dos dias da semana e tipos de encontro para o calendário
        const CALENDARIO_MAP = {
            'terca': 'encontros_terca',
            'quarta': 'encontros_quarta',
            'sabado': 'encontros_sabado',
            'missa': 'missas'
        };

        // Opções de Status de Presença e Cores
        const STATUS_OPTIONS = [
            { value: 'F', text: 'F (Falta)', class: 'F' },
            { value: 'P', text: 'P (Presença)', class: 'P' },
            { value: 'FJ', text: 'FJ (Justificada)', class: 'FJ' },
        ];
        const STATUS_OPTIONS_ENCONTRO = [ 
            ...STATUS_OPTIONS,
            { value: 'FR', text: 'FR (Reposta)', class: 'FR' } // FR apenas para encontros
        ];


        // Variáveis de escopo
        let app;
        let db;
        
        // Variáveis de controle de roteamento
        const urlParams = new URLSearchParams(window.location.search);
        const turmaId = urlParams.get('turmaId');
        const chaveSecreta = urlParams.get('key');
        
        const statusMessageDiv = document.getElementById('status-message');
        statusMessageDiv.style.display = 'block'; 

        // 1. Tenta inicializar o Firebase
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            statusMessageDiv.innerHTML = 'Conexão Firebase OK. Carregando interface...';
            statusMessageDiv.style.backgroundColor = '#e6ffe6';
            statusMessageDiv.style.borderColor = '#00cc00';
            statusMessageDiv.style.color = '#006600';
        } catch (error) {
            statusMessageDiv.innerHTML = `ERRO CRÍTICO DE INICIALIZAÇÃO DO FIREBASE. Detalhe: ${error.message}.`;
            console.error("ERRO CRÍTICO DE INICIALIZAÇÃO DO FIREBASE:", error);
            window.onload = function() {}; 
        }

        // 2. Lógica de Roteamento (Executada após a conexão ser estabelecida)
        window.onload = function() {
            if (turmaId && chaveSecreta) {
                // Modo CATEQUISTA (Com ID e CHAVE na URL)
                document.getElementById('catequista-page').style.display = 'block';
                document.getElementById('admin-panel').style.display = 'none';
                validarChaveEIniciar(turmaId, chaveSecreta);
            } else {
                // Modo ADMINISTRADOR (Sem ID/Chave na URL)
                document.getElementById('admin-panel').style.display = 'block';
                document.getElementById('catequista-page').style.display = 'none';
                carregarTurmas(); 
                carregarDatasCalendario(); // Carregar dados do calendário
                
                // Adicionar Listeners de Formulário Admin
                document.getElementById('form-turma').addEventListener('submit', (e) => {
                    e.preventDefault();
                    adicionarTurmaIndividual();
                });
                document.getElementById('form-participante').addEventListener('submit', (e) => {
                    e.preventDefault();
                    adicionarParticipanteIndividual();
                });
                
                // CORREÇÃO DE ESCOPO: Adiciona event listeners para botões que chamavam funções globais
                document.getElementById('btn-adicionar-turmas-lote').addEventListener('click', adicionarTurmasEmLote);
                document.getElementById('btn-adicionar-participantes-lote').addEventListener('click', adicionarParticipantesEmLote);
                document.getElementById('btn-salvar-range-datas').addEventListener('click', salvarRangeDatas);
                document.getElementById('btn-gerar-relatorio').addEventListener('click', gerarRelatorio);
                
                // Listeners para botões de salvar data manual
                document.getElementById('btn-salvar-terca').addEventListener('click', () => salvarDatas('encontros_terca'));
                document.getElementById('btn-salvar-quarta').addEventListener('click', () => salvarDatas('encontros_quarta'));
                document.getElementById('btn-salvar-sabado').addEventListener('click', () => salvarDatas('encontros_sabado'));
                document.getElementById('btn-salvar-missas').addEventListener('click', () => salvarDatas('missas'));

            }
        };

        // =========================================================================
        //                  FUNÇÕES MODO CATEQUISTA (Registro de Presença em Matriz)
        // =========================================================================

        /**
         * Valida a chave secreta e inicia o carregamento da matriz de presença.
         */
        async function validarChaveEIniciar(turmaId, chaveSecreta) {
            try {
                const turmaRef = doc(db, "turmas", turmaId);
                const turmaDoc = await getDoc(turmaRef); 

                if (!turmaDoc.exists) {
                     document.getElementById('catequista-page').innerHTML = "<h1>Erro: Turma Inexistente.</h1>";
                     return;
                }

                const data = turmaDoc.data();
                if (data.chave_secreta !== chaveSecreta) {
                     document.getElementById('catequista-page').innerHTML = "<h1>Erro: Chave de Acesso Inválida.</h1>";
                     return;
                }
                if (!data.dia_semana || !CALENDARIO_MAP[data.dia_semana]) {
                    document.getElementById('catequista-page').innerHTML = "<h1>Erro de Configuração: Esta turma não tem um Dia de Semana (terca, quarta, sabado) configurado no Painel Admin.</h1>";
                    return;
                }

                // Se a chave for válida, carrega a interface
                document.getElementById('turma-info').innerHTML = `Turma: ${data.nome} | Catequista: ${data.catequista} | Dia: ${data.dia_semana.toUpperCase()}`;
                
                // Carregar a Matriz de Presença
                carregarMatrizPresenca(turmaId, data.dia_semana);
                document.getElementById('status-message').style.display = 'none'; 

            } catch (error) {
                console.error("Erro na validação da chave ou comunicação:", error);
                document.getElementById('catequista-page').innerHTML = `<h1>Erro: Falha ao carregar dados. Detalhes: ${error.message}</h1>`;
                document.getElementById('status-message').innerHTML = `ERRO: Falha ao carregar dados da turma.`;
            }
        }

        /**
         * Carrega a Matriz de Presença: Participantes vs Datas (Encontros + Missas).
         */
        async function carregarMatrizPresenca(turmaId, diaSemanaTurma) {
            const statusDiv = document.getElementById('matriz-presenca-status');
            statusDiv.innerHTML = 'Carregando matriz...';

            try {
                // 1. Obter Participantes da Turma
                const participantesQuery = query(collection(db, "participantes"), where("turma_id", "==", turmaId));
                const participantesSnapshot = await getDocs(participantesQuery);
                const participantes = {};
                participantesSnapshot.forEach(doc => {
                    participantes[doc.id] = { nome: doc.data().nome, presencas: {} }; // Inicializa presenças como objeto
                });

                // 2. Obter Datas de Encontro e Missa
                const encontroDocId = CALENDARIO_MAP[diaSemanaTurma];
                const missaDocId = CALENDARIO_MAP['missa'];
                
                const encontroDoc = await getDoc(doc(db, "calendario", encontroDocId));
                const missaDoc = await getDoc(doc(db, "calendario", missaDocId));

                const datasEncontros = encontroDoc.exists ? encontroDoc.data().datas : [];
                const datasMissas = missaDoc.exists ? missaDoc.data().datas : [];
                
                // Combina e classifica as datas
                const todasDatas = [
                    ...datasEncontros.map(d => ({ data: d, tipo: 'encontro' })), 
                    ...datasMissas.map(d => ({ data: d, tipo: 'missa' }))
                ].sort((a, b) => new Date(a.data) - new Date(b.data));

                // 3. Obter Registros de Presença Atuais (em tempo real)
                const presencasQuery = query(collection(db, "presencas"), where("turma_id", "==", turmaId));
                
                onSnapshot(presencasQuery, (snapshot) => {
                    // Mapeia os registros de presença (participante_id -> data_str -> status)
                    const presencasMap = {};
                    snapshot.forEach(doc => {
                        const reg = doc.data();
                        const key = `${reg.participante_id}_${reg.data_str}`; // Chave única
                        presencasMap[key] = { status: reg.status, docId: doc.id };
                    });

                    renderizarMatriz(participantes, todasDatas, presencasMap);
                }, (error) => {
                    console.error("Erro no listener de presenças:", error);
                    statusDiv.innerHTML = 'Erro ao carregar dados de presença.';
                });

            } catch (error) {
                console.error("Erro ao carregar matriz:", error);
                statusDiv.innerHTML = `Falha ao carregar matriz: ${error.message}`;
            }
        }

        /**
         * Renderiza a tabela de matriz interativa.
         */
        function renderizarMatriz(participantes, todasDatas, presencasMap) {
            const table = document.getElementById('matriz-tabela');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            
            thead.innerHTML = '';
            tbody.innerHTML = '';
            
            // Verifica se há participantes e datas
            const participanteIds = Object.keys(participantes);
            if (participanteIds.length === 0) {
                document.getElementById('matriz-presenca-status').innerHTML = 'Nenhum catequizando cadastrado nesta turma.';
                return;
            }
            if (todasDatas.length === 0) {
                document.getElementById('matriz-presenca-status').innerHTML = 'Nenhuma data de encontro ou missa cadastrada para esta turma.';
                return;
            }
            
            document.getElementById('matriz-presenca-status').innerHTML = 'Tabela carregada. Clique nas células para alterar.';


            // 1. Construir Cabeçalho (Datas)
            const headerRow = thead.insertRow();
            headerRow.insertCell().textContent = 'Catequizando'; // Primeira célula vazia
            
            todasDatas.forEach(item => {
                const th = document.createElement('th');
                const label = item.tipo === 'encontro' ? 'EN' : 'MS';
                th.innerHTML = `${label}<br>${item.data.substring(5)}`; // Mês-Dia
                headerRow.appendChild(th);
            });

            // 2. Construir Corpo (Participantes)
            participanteIds.forEach(participanteId => {
                const row = tbody.insertRow();
                row.insertCell().textContent = participantes[participanteId].nome;

                todasDatas.forEach(item => {
                    const cell = row.insertCell();
                    const dateStr = item.data;
                    const key = `${participanteId}_${dateStr}`;
                    const registroAtual = presencasMap[key] || { status: 'F', docId: null }; // Default é Falta
                    const isEncontro = item.tipo === 'encontro';

                    // Cria o elemento Select
                    const select = document.createElement('select');
                    select.className = registroAtual.status; // Adiciona a classe inicial para cor
                    select.dataset.participanteId = participanteId;
                    select.dataset.dateStr = dateStr;
                    select.dataset.tipo = item.tipo;
                    select.dataset.docId = registroAtual.docId || ''; // Se existir, armazena o docId

                    // Define as opções (com ou sem 'FR')
                    const options = isEncontro ? STATUS_OPTIONS_ENCONTRO : STATUS_OPTIONS;
                    
                    options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt.value;
                        option.textContent = opt.value;
                        option.className = opt.class; // Adiciona classe na option (embora o select controle melhor a cor)
                        if (opt.value === registroAtual.status) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                    
                    // Adiciona o listener de mudança
                    select.onchange = (e) => {
                        const novoStatus = e.target.value;
                        const target = e.target;
                        
                        // Atualiza a cor imediatamente
                        target.className = novoStatus;
                        
                        // Salva no Firestore
                        salvarStatusPresenca(
                            target.dataset.participanteId, 
                            target.dataset.dateStr, 
                            target.dataset.tipo,
                            novoStatus,
                            target.dataset.docId
                        );
                    };

                    cell.appendChild(select);
                });
            });
        }
        
        /**
         * Salva o status de presença no Firestore (Cria/Atualiza o registro).
         * @param {string} participanteId 
         * @param {string} dateStr Data no formato AAAA-MM-DD
         * @param {string} tipo 'encontro' ou 'missa'
         * @param {string} status Novo status (P, F, FJ, FR)
         * @param {string} docId ID do documento existente (opcional)
         */
        function salvarStatusPresenca(participanteId, dateStr, tipo, status, docId) {
            const dataToSave = {
                participante_id: participanteId,
                turma_id: turmaId,
                data_str: dateStr, // Guarda a data como string para fácil consulta
                tipo: tipo,
                status: status,
                data_registro: serverTimestamp(), // Carimbo de data/hora do momento do registro
                chave_secreta: chaveSecreta // Para regras de segurança
            };

            if (docId) {
                // Se já existe, atualiza
                const docRef = doc(db, "presencas", docId);
                updateDoc(docRef, dataToSave)
                    .then(() => console.log(`Atualizado ${participanteId} em ${dateStr} para ${status}`))
                    .catch(error => alert(`Erro ao atualizar presença: ${error.message}`));
            } else {
                // Se não existe, cria (e a matriz será atualizada pelo onSnapshot, pegando o novo docId)
                addDoc(collection(db, "presencas"), dataToSave)
                    .then((newDocRef) => console.log(`Criado ${newDocRef.id} para ${participanteId} em ${dateStr}`))
                    .catch(error => alert(`Erro ao registrar presença: ${error.message}`));
            }
        }


        // =========================================================================
        //                  FUNÇÕES MODO ADMINISTRADOR (CRUD, Calendário e Relatórios)
        // =========================================================================
        
        /**
         * Gera um array de datas AAAA-MM-DD dentro de um intervalo, filtrando por dia da semana.
         * @param {string} startStr Data inicial (AAAA-MM-DD).
         * @param {string} endStr Data final (AAAA-MM-DD).
         * @param {number|string} targetDay Dia da semana (2=Ter, 3=Qua, 6=Sab) ou 'all'.
         * @returns {string[]} Array de datas no formato AAAA-MM-DD.
         */
        function generateDatesInRange(startStr, endStr, targetDay) {
            const dates = [];
            // Adiciona T00:00:00 para evitar problemas de fuso horário
            let start = new Date(startStr + 'T00:00:00');
            let end = new Date(endStr + 'T00:00:00');
            
            if (isNaN(start.getTime()) || isNaN(end.getTime()) || start > end) {
                throw new Error("Formato de data inválido ou data inicial é posterior à final. Use AAAA-MM-DD.");
            }

            const targetDayNum = parseInt(targetDay);
            const isAll = targetDay === 'all';
            
            let currentDate = new Date(start);
            
            // Avança para o primeiro dia de interesse (se não for 'all')
            if (!isAll && currentDate.getDay() !== targetDayNum) {
                while (currentDate.getDay() !== targetDayNum && currentDate <= end) {
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }

            // Itera e coleta as datas
            while (currentDate.getTime() <= end.getTime()) {
                if (isAll || currentDate.getDay() === targetDayNum) {
                    dates.push(currentDate.toISOString().split('T')[0]);
                }
                
                // Se não for 'all', pula 7 dias (próximo dia da semana), senão, pula 1 dia
                if (!isAll) {
                    currentDate.setDate(currentDate.getDate() + 7);
                } else {
                     currentDate.setDate(currentDate.getDate() + 1);
                }
            }
            
            return dates;
        }

        /**
         * Lógica para salvar datas geradas por um intervalo.
         */
        async function salvarRangeDatas() {
            const startStr = document.getElementById('range-start-date').value.trim();
            const endStr = document.getElementById('range-end-date').value.trim();
            const targetDay = document.getElementById('range-target-day').value;
            const docId = document.getElementById('range-target-doc').value;
            const statusDiv = document.getElementById('range-status');
            
            statusDiv.textContent = 'Iniciando processamento...';
            statusDiv.style.color = '#007bff';

            if (!startStr || !endStr || !targetDay || !docId) {
                statusDiv.textContent = "ERRO: Por favor, preencha a Data de Início, Data Final, Dia da Semana e o Documento de Destino.";
                statusDiv.style.color = '#cc0000';
                return;
            }
            
            // Verifica formato AAAA-MM-DD
            if (!/^\d{4}-\d{2}-\d{2}$/.test(startStr) || !/^\d{4}-\d{2}-\d{2}$/.test(endStr)) {
                statusDiv.textContent = "ERRO DE FORMATO: As datas DEVE ser AAAA-MM-DD (ex: 2026-03-03). Verifique se não está usando DD/MM/AAAA.";
                statusDiv.style.color = '#cc0000';
                return;
            }

            try {
                let generatedDates;
                
                let jsDay;
                if (targetDay === 'all') {
                    jsDay = 'all';
                } else {
                    jsDay = parseInt(targetDay);
                }
                
                generatedDates = generateDatesInRange(startStr, endStr, jsDay);
                
                if (generatedDates.length === 0) {
                    statusDiv.textContent = "Nenhuma data encontrada no intervalo para o dia da semana selecionado. Verifique o intervalo.";
                    statusDiv.style.color = '#cc0000';
                    return;
                }
                
                console.log("Datas Geradas Prontas para Salvar:", docId, generatedDates); // LOG DE DEBUG

                // Salva no Firestore
                await setDoc(doc(db, "calendario", docId), {
                    datas: generatedDates
                }, { merge: true });

                statusDiv.textContent = `Sucesso! ${generatedDates.length} datas geradas e salvas em ${docId}.`;
                statusDiv.style.color = '#006600';
                carregarDatasCalendario(); // Recarrega os textareas de visualização

            } catch (error) {
                console.error("ERRO CRÍTICO na geração ou salvamento do intervalo:", error);
                // Reporta erro de permissão ou de cálculo no status
                statusDiv.textContent = `ERRO: Falha ao salvar no Firebase. Verifique o Console (F12) e as Regras de Segurança. Detalhe: ${error.message}`;
                statusDiv.style.color = '#cc0000';
            }
        }
        
        /**
         * Carrega as datas de encontros e missas para os textareas.
         */
        async function carregarDatasCalendario() {
            const dias = ['encontros_terca', 'encontros_quarta', 'encontros_sabado', 'missas'];
            try {
                for (const dia of dias) {
                    const docRef = doc(db, "calendario", dia);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const datas = docSnap.data().datas || [];
                        const elementId = dia.replace('_', '-');
                        const element = document.getElementById(`datas-${elementId}`);
                        if (element) {
                            element.value = datas.join('\n');
                        }
                    }
                }
            } catch (error) {
                console.error("Erro ao carregar datas do calendário:", error);
                // Não é um erro crítico, mas alertamos o admin
                // alert("Erro ao carregar calendário. Verifique as regras de segurança.");
            }
        }
        
        /**
         * Salva as datas do calendário no Firestore (edição manual).
         */
        function salvarDatas(docId) {
            const elementId = docId.replace('_', '-');
            const element = document.getElementById(`datas-${elementId}`);
            if (!element) return;
            
            // Limpa o texto, remove linhas vazias e duplicações, e garante o formato AAAA-MM-DD
            const rawDates = element.value.split('\n').map(d => d.trim()).filter(d => d.length === 10 && d.includes('-'));
            const datasUnicas = Array.from(new Set(rawDates)).sort();

            if (rawDates.some(d => !/^\d{4}-\d{2}-\d{2}$/.test(d))) {
                 alert("ATENÇÃO: Algumas datas parecem estar no formato incorreto. Use AAAA-MM-DD (ex: 2026-03-03).");
            }
            
            console.log("Datas Manuais Prontas para Salvar:", docId, datasUnicas); // LOG DE DEBUG

            setDoc(doc(db, "calendario", docId), {
                datas: datasUnicas
            }, { merge: true })
            .then(() => {
                alert(`Datas para ${docId.toUpperCase()} salvas com sucesso!`);
                element.value = datasUnicas.join('\n'); // Atualiza o textarea com o formato limpo
            })
            .catch(error => console.error(`Erro ao salvar datas ${docId}:`, error));
        }

        /**
         * Carrega todas as turmas para as listas e selects do painel administrativo.
         */
        function carregarTurmas() {
            getDocs(collection(db, "turmas")).then((snapshot) => {
                const listaTurmas = document.getElementById('lista-turmas');
                const selectParticipante = document.getElementById('turma-selecionada-participante');
                const selectRelatorio = document.getElementById('turma-selecionada-relatorio');
                
                listaTurmas.innerHTML = '';
                selectParticipante.innerHTML = '<option value="">Selecione a Turma</option>';
                selectRelatorio.innerHTML = '<option value="">Selecione a Turma</option>';

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const id = doc.id;
                    
                    // Lista para edição
                    const li = document.createElement('li');
                    const diaText = data.dia_semana ? ` (${data.dia_semana.toUpperCase()})` : '';
                    li.textContent = `${id}: ${data.nome} - Catequista: ${data.catequista}${diaText} (Chave: ${data.chave_secreta})`;
                    li.onclick = () => preencherFormularioTurma(id, data); 
                    listaTurmas.appendChild(li);

                    // Selects
                    const optionP = new Option(data.nome, id);
                    const optionR = new Option(data.nome, id);
                    selectParticipante.add(optionP);
                    selectRelatorio.add(optionR);
                });
                document.getElementById('status-message').style.display = 'none'; 
            }).catch(error => {
                console.error("Erro ao carregar turmas:", error);
                document.getElementById('lista-turmas').innerHTML = '<li><strong>ERRO: Permissão negada!</strong> Por favor, verifique as Regras de Segurança.</li>';
                document.getElementById('status-message').innerHTML = `ERRO DE PERMISSÃO: ${error.message}. Acesso à gestão de turmas negado.`;
                document.getElementById('status-message').style.backgroundColor = '#ffcccc';
                document.getElementById('status-message').style.borderColor = '#cc0000';
                document.getElementById('status-message').style.color = '#cc0000';
                document.getElementById('status-message').style.display = 'block';
            });
        }

        /**
         * Preenche o formulário de turma para edição.
         */
        function preencherFormularioTurma(id, data) {
            document.getElementById('turma-id').value = id;
            document.getElementById('turma-nome').value = data.nome;
            document.getElementById('turma-catequista').value = data.catequista;
            document.getElementById('turma-chave').value = data.chave_secreta;
            document.getElementById('turma-dia-semana').value = data.dia_semana || ''; // Novo campo
        }

        /**
         * Adiciona ou Altera uma Turma individualmente.
         */
        function adicionarTurmaIndividual() {
            const id = document.getElementById('turma-id').value.trim();
            const nome = document.getElementById('turma-nome').value.trim();
            const catequista = document.getElementById('turma-catequista').value.trim();
            const chave_secreta = document.getElementById('turma-chave').value.trim();
            const dia_semana = document.getElementById('turma-dia-semana').value; // NOVO: Pega o valor do select

            if (!dia_semana) {
                 alert("Por favor, selecione o Dia da Semana para vincular o calendário de encontros.");
                 return;
            }
            
            setDoc(doc(db, "turmas", id), {
                nome: nome,
                catequista: catequista,
                chave_secreta: chave_secreta,
                dia_semana: dia_semana
            }, { merge: true }) 
            .then(() => {
                alert(`Turma ${id} adicionada/atualizada! Dia da semana: ${dia_semana.toUpperCase()}`);
                document.getElementById('form-turma').reset();
                carregarTurmas();
            })
            .catch(error => console.error("Erro ao adicionar/atualizar turma:", error));
        }

        /**
         * Adiciona ou Altera Turmas em Lote.
         */
        function adicionarTurmasEmLote() {
            const loteTexto = document.getElementById('turmas-lote').value.trim();
            if (!loteTexto) return;

            const linhas = loteTexto.split('\n').filter(line => line.trim() !== ''); // Garante que linhas vazias sejam ignoradas
            const batch = writeBatch(db); 
            let successCount = 0;
            let errorLines = [];

            linhas.forEach((linha, index) => {
                // Divide por vírgula e remove espaços em branco extras
                const partes = linha.split(',').map(s => s.trim());
                
                // Formato esperado: ID, Nome, Catequista, ChaveSecreta, DiaDaSemana
                if (partes.length === 5) {
                    const [id, nome, catequista, chave_secreta, dia_semana] = partes;
                    
                    if (!id || !nome || !chave_secreta || !dia_semana || !['terca', 'quarta', 'sabado'].includes(dia_semana.toLowerCase())) {
                        errorLines.push(`Linha ${index + 1}: Dados inválidos ou Dia da Semana incorreto.`);
                        return;
                    }
                    
                    const turmaRef = doc(db, "turmas", id);
                    batch.set(turmaRef, { nome, catequista, chave_secreta, dia_semana: dia_semana.toLowerCase() }, { merge: true });
                    successCount++;
                } else {
                    errorLines.push(`Linha ${index + 1}: Esperado 5 campos, encontrado ${partes.length}.`);
                }
            });

            if (successCount === 0) {
                 alert(`Nenhuma turma adicionada. Verifique o formato do lote. ${errorLines.join(' | ')}`);
                 return;
            }

            batch.commit()
                .then(() => {
                    let message = `Lote processado. ${successCount} turmas adicionadas/atualizadas com sucesso.`;
                    if (errorLines.length > 0) {
                        message += ` ${errorLines.length} linhas com erro (ver console para detalhes).`;
                        console.error("Erros no Lote de Turmas:", errorLines);
                    }
                    alert(message);
                    document.getElementById('turmas-lote').value = '';
                    carregarTurmas();
                })
                .catch(error => console.error("Erro ao submeter o lote de turmas ao Firestore:", error));
        }

        /**
         * Adiciona um Catequizando individualmente.
         */
        function adicionarParticipanteIndividual() {
            const turmaId = document.getElementById('turma-selecionada-participante').value;
            const nome = document.getElementById('participante-nome').value.trim();

            if (!turmaId || !nome) {
                alert("Preencha o nome e selecione a Turma.");
                return;
            }

            addDoc(collection(db, "participantes"), {
                nome: nome,
                turma_id: turmaId
            })
            .then(() => {
                alert(`Catequizando ${nome} adicionado na Turma ${turmaId} com ID automático!`);
                document.getElementById('form-participante').reset();
            })
            .catch(error => console.error("Erro ao adicionar catequizando:", error));
        }

        /**
         * Adiciona Catequizandos em Lote.
         */
        function adicionarParticipantesEmLote() {
            const turmaId = document.getElementById('turma-selecionada-participante').value;
            const loteTexto = document.getElementById('participantes-lote').value.trim();
            if (!turmaId || !loteTexto) {
                alert("Selecione a turma e forneça os dados em lote.");
                return;
            }

            const linhas = loteTexto.split('\n').filter(line => line.trim() !== '');
            const batch = writeBatch(db); 

            linhas.forEach(linha => {
                const nome = linha.trim(); 
                if (nome) {
                    const participanteRef = doc(collection(db, "participantes")); 
                    batch.set(participanteRef, { nome, turma_id: turmaId });
                }
            });

            batch.commit()
                .then(() => {
                    alert("Catequizandos em lote adicionados com IDs automáticos!");
                    document.getElementById('participantes-lote').value = '';
                })
                .catch(error => console.error("Erro ao adicionar participantes em lote:", error));
        }

        /**
         * Gera o relatório de presença para a turma selecionada.
         */
        async function gerarRelatorio() {
            const turmaId = document.getElementById('turma-selecionada-relatorio').value;
            const resultadoDiv = document.getElementById('resultado-relatorio');
            resultadoDiv.innerHTML = '<p>Gerando relatório...</p>';

            if (!turmaId) {
                resultadoDiv.innerHTML = 'Selecione uma turma.';
                return;
            }
            
            try {
                // 1. Obter informações da Turma (para dia da semana)
                const turmaDoc = await getDoc(doc(db, "turmas", turmaId));
                if (!turmaDoc.exists || !turmaDoc.data().dia_semana) {
                    resultadoDiv.innerHTML = 'Erro: Turma não encontrada ou Dia da Semana não configurado.';
                    return;
                }
                const diaSemanaTurma = turmaDoc.data().dia_semana;
                const encontroDocId = CALENDARIO_MAP[diaSemanaTurma];

                // 2. Obter participantes da turma
                const participantesQuery = query(collection(db, "participantes"), where("turma_id", "==", turmaId));
                const participantesSnapshot = await getDocs(participantesQuery);
                
                const participantes = {};
                participantesSnapshot.forEach(doc => {
                    participantes[doc.id] = { nome: doc.data().nome, presencas: 0, faltas: 0 };
                });

                // 3. Obter Total de Encontros (Datas)
                const encontroDoc = await getDoc(doc(db, "calendario", encontroDocId));
                const datasEncontros = encontroDoc.exists ? encontroDoc.data().datas : [];
                const totalEncontros = datasEncontros.length;
                
                // 4. Obter Registros de Presença (Contando P e FR)
                const presencasQuery = query(
                    collection(db, "presencas"),
                    where("turma_id", "==", turmaId),
                    where("tipo", "==", "encontro")
                );
                const presencasSnapshot = await getDocs(presencasQuery);
                
                // Mapeia o número de presenças válidas (P, FR, FJ) por participante
                const presencasContagem = {};
                presencasSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.status === 'P' || data.status === 'FR' || data.status === 'FJ') {
                        // Contamos P, FR e FJ como presença válida
                        presencasContagem[data.participante_id] = (presencasContagem[data.participante_id] || 0) + 1;
                    }
                });

                
                // 5. Montar o relatório
                let relatorioHTML = `<h3>Relatório da Turma ${turmaId} (${diaSemanaTurma.toUpperCase()})</h3>`;
                relatorioHTML += `<p>Total de Encontros Previstos: <strong>${totalEncontros}</strong></p>`;
                
                relatorioHTML += '<table><thead><tr><th>Nome</th><th>Presenças (P/FR/FJ)</th><th>Faltas (F)</th></tr></thead><tbody>';

                for (const id in participantes) {
                    const p = participantes[id];
                    const numPresencas = presencasContagem[id] || 0;
                    const faltas = totalEncontros - numPresencas;
                    
                    relatorioHTML += `<tr><td>${p.nome}</td><td>${numPresencas}</td><td><strong>${faltas}</strong></td></tr>`;
                }
                
                relatorioHTML += '</tbody></table>';
                resultadoDiv.innerHTML = relatorioHTML;

            } catch (error) {
                console.error("Erro ao gerar relatório:", error);
                resultadoDiv.innerHTML = `Erro ao gerar relatório: ${error.message}`;
            }
        }
    </script>
</body>
</html>
