<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Presença Catequese</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f9; padding: 20px; color: #333; }
        h1, h2, h3 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 5px; margin-top: 20px; }
        section { background-color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        input[type="text"], select, textarea { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        ul#lista-turmas li { background-color: #e9ecef; margin: 5px 0; padding: 10px; border-radius: 4px; cursor: pointer; }
        ul#lista-turmas li:hover { background-color: #cfd6de; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        table, th, td { border: 1px solid #ddd; }
        th, td { padding: 10px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    
    <!-- 1. PAINEL ADMINISTRATIVO (Visível sem ID na URL) -->
    <div id="admin-panel" style="display: none;">
        <h1>Painel Administrativo</h1>
        
        <section>
            <h2>Gerenciar Turmas (CRUD)</h2>
            <form id="form-turma">
                <input type="text" id="turma-id" placeholder="ID da Turma (Ex: A1)" required>
                <input type="text" id="turma-nome" placeholder="Nome da Turma" required>
                <input type="text" id="turma-catequista" placeholder="Nome do Catequista" required>
                <!-- Campo para a chave secreta que será usada no link do catequista -->
                <input type="text" id="turma-chave" placeholder="Chave Secreta (Senha de Acesso da Turma)" required>
                <button type="submit">Adicionar/Atualizar Turma</button>
            </form>
            
            <h3>Adicionar Turmas em Lote</h3>
            <p>Formato: ID,Nome,Catequista,ChaveSecreta (uma por linha)</p>
            <textarea id="turmas-lote" rows="5" placeholder="A1,Eucaristia A,Maria Silva,senha123&#10;B2,Crisma B,João Souza,chave456"></textarea>
            <button onclick="adicionarTurmasEmLote()">Adicionar em Lote</button>
            
            <h3>Turmas Existentes (Clique para Editar)</h3>
            <ul id="lista-turmas"></ul>
        </section>

        <section>
            <h2>Gerenciar Catequizandos (CRUD)</h2>
            <label for="turma-selecionada-participante">Vincular à Turma:</label>
            <select id="turma-selecionada-participante" required>
                <option value="">Carregando Turmas...</option>
            </select>

            <form id="form-participante">
                <input type="text" id="participante-id" placeholder="ID do Catequizando (Ex: p001)" required>
                <input type="text" id="participante-nome" placeholder="Nome Completo" required>
                <button type="submit">Adicionar/Atualizar Catequizando</button>
            </form>

            <h3>Adicionar Catequizandos em Lote</h3>
            <p>Formato: ID,Nome (uma por linha, vincular à turma selecionada acima)</p>
            <textarea id="participantes-lote" rows="5" placeholder="p001,Ana Costa&#10;p002,Bruno Lopes"></textarea>
            <button onclick="adicionarParticipantesEmLote()">Adicionar em Lote</button>
        </section>
        
        <section>
            <h2>Relatórios de Presença</h2>
            <label for="turma-selecionada-relatorio">Selecionar Turma:</label>
            <select id="turma-selecionada-relatorio" required>
                <option value="">Carregando Turmas...</option>
            </select>
            <button onclick="gerarRelatorio()">Gerar Relatório</button>
            <div id="resultado-relatorio"></div>
        </section>
    </div>


    <!-- 2. PÁGINA DO CATEQUISTA (Visível com ID na URL) -->
    <div id="catequista-page" style="display: none;">
        <h1 id="titulo-turma">Registro de Presença</h1>
        <p id="turma-info" style="font-size: 1.2em; font-weight: bold;"></p>
        
        <section id="registro-presenca">
            <h2>Marcar Presença</h2>
            <select id="participante-select">
                <option value="">Carregando Participantes...</option>
            </select>
            <button onclick="registrarPresenca('encontro')">Registrar Presença no Encontro</button>
            <button onclick="registrarPresenca('missa')" style="background-color: #28a745;">Registrar Presença na Missa</button>
        </section>
        
        <section>
            <h2>Presenças Registradas (Últimos 10 Encontros/Missas)</h2>
            <ul id="presencas-list"></ul>
        </section>
    </div>

    <!-- --------------------------------------- -->
    <!-- Configurações e Script -->
    <!-- --------------------------------------- -->
    <script type="module">
        // Importa módulos necessários do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy, limit, FieldValue, Timestamp, writeBatch } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js";

        // Variáveis globais para simular o ambiente Canvas
        const firebaseConfig = {
            apiKey: "AIzaSyDqn5MejlYyNmXK-OZayhOZ5SrzN3YcNCM", // CREDENCIAL ATUALIZADA
            authDomain: "dados-catequese.firebaseapp.com",
            projectId: "dados-catequese",
            storageBucket: "dados-catequese.firebasestorage.app",
            messagingSenderId: "420948905617",
            appId: "1:420948905617:web:b08e29cf50873ff804f930"
        };

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Variáveis de controle de roteamento
        const urlParams = new URLSearchParams(window.location.search);
        const turmaId = urlParams.get('turmaId');
        const chaveSecreta = urlParams.get('key');

        // Função de inicialização
        window.onload = function() {
            if (turmaId && chaveSecreta) {
                // Modo CATEQUISTA (Com ID e CHAVE na URL)
                document.getElementById('catequista-page').style.display = 'block';
                validarChaveEIniciar(turmaId, chaveSecreta);
            } else {
                // Modo ADMINISTRADOR (Sem ID/Chave na URL)
                document.getElementById('admin-panel').style.display = 'block';
                carregarTurmas(); 
                
                // Adicionar Listeners de Formulário Admin
                document.getElementById('form-turma').addEventListener('submit', (e) => {
                    e.preventDefault();
                    adicionarTurmaIndividual();
                });
                document.getElementById('form-participante').addEventListener('submit', (e) => {
                    e.preventDefault();
                    adicionarParticipanteIndividual();
                });
            }
        };

        // =========================================================================
        //                  FUNÇÕES MODO CATEQUISTA (Registro de Presença)
        // =========================================================================

        /**
         * Valida a chave secreta da URL contra a chave no Firestore antes de carregar a turma.
         * @param {string} turmaId ID da turma.
         * @param {string} chaveSecreta Chave de acesso.
         */
        async function validarChaveEIniciar(turmaId, chaveSecreta) {
            try {
                const turmaRef = db.collection("turmas").doc(turmaId);
                const turmaDoc = await turmaRef.get();

                if (!turmaDoc.exists) {
                     document.getElementById('catequista-page').innerHTML = "<h1>Erro: Turma Inexistente.</h1>";
                     return;
                }

                const data = turmaDoc.data();
                if (data.chave_secreta !== chaveSecreta) {
                     document.getElementById('catequista-page').innerHTML = "<h1>Erro: Chave de Acesso Inválida.</h1>";
                     return;
                }

                // Se a chave for válida, carrega a interface
                document.getElementById('turma-info').innerHTML = `Turma: ${data.nome} | Catequista: ${data.catequista}`;
                carregarParticipantes(turmaId);
                visualizarPresencas(turmaId);

            } catch (error) {
                console.error("Erro na validação da chave ou comunicação:", error);
                document.getElementById('catequista-page').innerHTML = `<h1>Erro: Falha ao carregar dados. Detalhes: ${error.message}</h1>`;
            }
        }

        /**
         * Carrega a lista de participantes da turma para o select.
         * @param {string} turmaId ID da turma.
         */
        function carregarParticipantes(turmaId) {
            db.collection("participantes").where("turma_id", "==", turmaId).get()
                .then((querySnapshot) => {
                    const select = document.getElementById('participante-select');
                    select.innerHTML = '<option value="">Selecione o Catequizando</option>'; // Limpa e adiciona opção padrão
                    querySnapshot.forEach((doc) => {
                        const participante = doc.data();
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.textContent = participante.nome;
                        select.appendChild(option);
                    });
                })
                .catch(error => console.error("Erro ao carregar participantes:", error));
        }

        /**
         * Registra a presença (Encontro ou Missa) no Firestore.
         * Inclui a chave secreta para validação via Firestore Rules (sem Auth).
         * @param {string} tipo 'encontro' ou 'missa'.
         */
        function registrarPresenca(tipo) {
            const participanteId = document.getElementById('participante-select').value;
            
            if (!participanteId) {
                alert("Selecione um catequizando para registrar a presença.");
                return;
            }

            db.collection("presencas").add({
                participante_id: participanteId,
                turma_id: turmaId,
                tipo: tipo,
                data: FieldValue.serverTimestamp(),
                chave_secreta: chaveSecreta // ESSENCIAL para a regra de segurança do Firestore
            })
            .then(() => {
                alert(`Presença (${tipo}) registrada com sucesso!`);
                visualizarPresencas(turmaId); // Atualiza a lista
            })
            .catch(error => console.error("Erro ao registrar presença:", error));
        }

        /**
         * Visualiza os últimos 10 registros de presença.
         * @param {string} turmaId ID da turma.
         */
        function visualizarPresencas(turmaId) {
            const list = document.getElementById('presencas-list');
            list.innerHTML = '<li>Carregando registros...</li>'; 

            // O uso de onSnapshot mantém a lista atualizada em tempo real
            db.collection("presencas").where("turma_id", "==", turmaId)
                .orderBy("data", "desc").limit(10).onSnapshot(async (snapshot) => {
                list.innerHTML = '';
                const presencaDocs = snapshot.docs;

                if (presencaDocs.length === 0) {
                    list.innerHTML = '<li>Nenhuma presença registrada ainda.</li>';
                    return;
                }

                for (const doc of presencaDocs) {
                    const registro = doc.data();
                    const item = document.createElement('li');
                    
                    // Busca o nome do participante para exibição
                    const pDoc = await db.collection("participantes").doc(registro.participante_id).get();
                    const nome = pDoc.data() ? pDoc.data().nome : "Participante Desconhecido";
                    
                    const dataObj = registro.data ? new Date(registro.data.toDate()) : new Date();
                    const dataFormatada = dataObj.toLocaleDateString('pt-BR', { dateStyle: 'short' }) + ' ' + 
                                          dataObj.toLocaleTimeString('pt-BR', { timeStyle: 'short' });
                    
                    item.textContent = `${dataFormatada} - ${nome} (${registro.tipo.toUpperCase()})`;
                    list.appendChild(item);
                }
            }, error => {
                console.error("Erro no listener de presenças:", error);
                list.innerHTML = '<li>Erro ao carregar registros.</li>';
            });
        }

        // =========================================================================
        //                  FUNÇÕES MODO ADMINISTRADOR (CRUD e Relatórios)
        // =========================================================================

        /**
         * Carrega todas as turmas para as listas e selects do painel administrativo.
         */
        function carregarTurmas() {
            db.collection("turmas").get().then((snapshot) => {
                const listaTurmas = document.getElementById('lista-turmas');
                const selectParticipante = document.getElementById('turma-selecionada-participante');
                const selectRelatorio = document.getElementById('turma-selecionada-relatorio');
                
                listaTurmas.innerHTML = '';
                selectParticipante.innerHTML = '<option value="">Selecione a Turma</option>';
                selectRelatorio.innerHTML = '<option value="">Selecione a Turma</option>';

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const id = doc.id;
                    
                    // Lista para edição
                    const li = document.createElement('li');
                    li.textContent = `${id}: ${data.nome} - Catequista: ${data.catequista} (Chave: ${data.chave_secreta})`;
                    li.onclick = () => preencherFormularioTurma(id, data); 
                    listaTurmas.appendChild(li);

                    // Selects
                    const optionP = new Option(data.nome, id);
                    const optionR = new Option(data.nome, id);
                    selectParticipante.add(optionP);
                    selectRelatorio.add(optionR);
                });
            }).catch(error => console.error("Erro ao carregar turmas:", error));
        }

        /**
         * Preenche o formulário de turma para edição.
         */
        function preencherFormularioTurma(id, data) {
            document.getElementById('turma-id').value = id;
            document.getElementById('turma-nome').value = data.nome;
            document.getElementById('turma-catequista').value = data.catequista;
            document.getElementById('turma-chave').value = data.chave_secreta;
        }

        /**
         * Adiciona ou Altera uma Turma individualmente.
         */
        function adicionarTurmaIndividual() {
            const id = document.getElementById('turma-id').value.trim();
            const nome = document.getElementById('turma-nome').value.trim();
            const catequista = document.getElementById('turma-catequista').value.trim();
            const chave_secreta = document.getElementById('turma-chave').value.trim();

            db.collection("turmas").doc(id).set({
                nome: nome,
                catequista: catequista,
                chave_secreta: chave_secreta
            }, { merge: true }) 
            .then(() => {
                alert(`Turma ${id} adicionada/atualizada! Chave: ${chave_secreta}`);
                document.getElementById('form-turma').reset();
                carregarTurmas();
            })
            .catch(error => console.error("Erro ao adicionar/atualizar turma:", error));
        }

        /**
         * Adiciona ou Altera Turmas em Lote.
         */
        function adicionarTurmasEmLote() {
            const loteTexto = document.getElementById('turmas-lote').value.trim();
            if (!loteTexto) return;

            const linhas = loteTexto.split('\n');
            const batch = db.batch();

            linhas.forEach(linha => {
                const partes = linha.split(',').map(s => s.trim());
                if (partes.length === 4) {
                    const [id, nome, catequista, chave_secreta] = partes;
                    const turmaRef = db.collection("turmas").doc(id);
                    batch.set(turmaRef, { nome, catequista, chave_secreta }, { merge: true });
                }
            });

            batch.commit()
                .then(() => {
                    alert("Turmas em lote adicionadas/atualizadas!");
                    document.getElementById('turmas-lote').value = '';
                    carregarTurmas();
                })
                .catch(error => console.error("Erro ao adicionar turmas em lote:", error));
        }

        /**
         * Adiciona ou Altera um Catequizando individualmente.
         */
        function adicionarParticipanteIndividual() {
            const turmaId = document.getElementById('turma-selecionada-participante').value;
            const id = document.getElementById('participante-id').value.trim();
            const nome = document.getElementById('participante-nome').value.trim();

            if (!turmaId || !id || !nome) {
                alert("Preencha todos os campos e selecione a Turma.");
                return;
            }

            db.collection("participantes").doc(id).set({
                nome: nome,
                turma_id: turmaId
            }, { merge: true })
            .then(() => {
                alert(`Catequizando ${nome} adicionado/atualizado na Turma ${turmaId}!`);
                document.getElementById('form-participante').reset();
            })
            .catch(error => console.error("Erro ao adicionar/atualizar catequizando:", error));
        }

        /**
         * Adiciona ou Altera Catequizandos em Lote.
         */
        function adicionarParticipantesEmLote() {
            const turmaId = document.getElementById('turma-selecionada-participante').value;
            const loteTexto = document.getElementById('participantes-lote').value.trim();
            if (!turmaId || !loteTexto) {
                alert("Selecione a turma e forneça os dados em lote.");
                return;
            }

            const linhas = loteTexto.split('\n');
            const batch = db.batch();

            linhas.forEach(linha => {
                const [id, nome] = linha.split(',').map(s => s.trim());
                if (id && nome) {
                    const participanteRef = db.collection("participantes").doc(id);
                    batch.set(participanteRef, { nome, turma_id: turmaId }, { merge: true });
                }
            });

            batch.commit()
                .then(() => {
                    alert("Catequizandos em lote adicionados/atualizados!");
                    document.getElementById('participantes-lote').value = '';
                })
                .catch(error => console.error("Erro ao adicionar participantes em lote:", error));
        }

        /**
         * Gera o relatório de presença para a turma selecionada.
         */
        async function gerarRelatorio() {
            const turmaId = document.getElementById('turma-selecionada-relatorio').value;
            const resultadoDiv = document.getElementById('resultado-relatorio');
            resultadoDiv.innerHTML = '<p>Gerando relatório...</p>';

            if (!turmaId) {
                resultadoDiv.innerHTML = 'Selecione uma turma.';
                return;
            }

            try {
                // 1. Obter participantes da turma
                const participantesSnapshot = await db.collection("participantes").where("turma_id", "==", turmaId).get();
                const participantes = {};
                participantesSnapshot.forEach(doc => {
                    participantes[doc.id] = { nome: doc.data().nome, presencas: 0, faltas: 0 };
                });

                // 2. Obter todas as presenças de 'encontro' (para calcular total de encontros e presenças)
                const presencasSnapshot = await db.collection("presencas")
                    .where("turma_id", "==", turmaId)
                    .where("tipo", "==", "encontro") 
                    .get();
                
                const datasEncontros = new Set();
                
                presencasSnapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Conta as presenças
                    if (participantes[data.participante_id]) {
                        participantes[data.participante_id].presencas++;
                    }
                    
                    // Conta as datas únicas de encontros (Total de Encontros)
                    const dataObj = data.data.toDate();
                    const dataStr = dataObj.toISOString().split('T')[0];
                    datasEncontros.add(dataStr);
                });

                const totalEncontros = datasEncontros.size;
                
                // 3. Montar o relatório
                let relatorioHTML = `<h3>Relatório da Turma ${turmaId}</h3>`;
                relatorioHTML += `<p>Total de Encontros Registrados: <strong>${totalEncontros}</strong></p>`;
                
                relatorioHTML += '<table><thead><tr><th>Nome</th><th>Presenças</th><th>Faltas</th></tr></thead><tbody>';

                for (const id in participantes) {
                    const p = participantes[id];
                    const faltas = totalEncontros - p.presencas;
                    p.faltas = faltas;
                    relatorioHTML += `<tr><td>${p.nome}</td><td>${p.presencas}</td><td><strong>${p.faltas}</strong></td></tr>`;
                }
                
                relatorioHTML += '</tbody></table>';
                resultadoDiv.innerHTML = relatorioHTML;

            } catch (error) {
                console.error("Erro ao gerar relatório:", error);
                resultadoDiv.innerHTML = `Erro ao gerar relatório: ${error.message}`;
            }
        }
    </script>
</body>
</html>
